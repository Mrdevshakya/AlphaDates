rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isFollowing(userId) {
      return userId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.following;
    }
    
    function isPublicProfile(userId) {
      return !get(/databases/$(database)/documents/users/$(userId)).data.isPrivate;
    }

    function isChatParticipant(participants) {
      return isSignedIn() && request.auth.uid in participants;
    }

    function isUsernameUnique(username) {
      return !exists(/databases/$(database)/documents/users/$(request.auth.uid)) ||
        (
          !exists(/databases/$(database)/documents/usernames/$(username)) ||
          get(/databases/$(database)/documents/usernames/$(username)).data.uid == request.auth.uid
        );
    }

    function isMatchParticipant(users) {
      return isSignedIn() && request.auth.uid in users;
    }

    // Matches
    match /matches/{matchId} {
      allow read: if isSignedIn() && isMatchParticipant(resource.data.users);
      allow create: if isSignedIn() && isMatchParticipant(request.resource.data.users);
      allow update: if isSignedIn() && isMatchParticipant(resource.data.users);
      allow delete: if false;  // Matches should not be deleted
    }

    // User presence status
    match /status/{userId} {
      allow read: if isSignedIn();  // Any signed-in user can read status
      allow write: if isSignedIn() && isOwner(userId);  // Only the user can update their own status
    }

    // Notifications
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && (
        resource.data.targetUserId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow create: if isSignedIn() && (
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.targetUserId == request.auth.uid
      );
      allow update: if isSignedIn() && (
        resource.data.targetUserId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
      allow delete: if isSignedIn() && (
        resource.data.targetUserId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      );
    }

    // Username reservations
    match /usernames/{username} {
      allow read: if true;  // Allow reading usernames without authentication
      allow create, update: if isSignedIn() && 
        request.resource.data.uid == request.auth.uid &&
        isUsernameUnique(username);
      allow delete: if isSignedIn() && resource.data.uid == request.auth.uid;
    }

    // User profiles
    match /users/{userId} {
      allow read: if true;  // Allow reading user profiles without authentication for sign-in
      allow create: if isSignedIn() && isOwner(userId) && 
        isUsernameUnique(request.resource.data.username);
      // Allow updates if:
      // 1. User is updating their own profile
      // 2. User is updating their own following list
      // 3. User is updating someone else's followers list (for follow/unfollow)
      allow update: if isSignedIn() && (
        (isOwner(userId) && (
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['username']) ||
          isUsernameUnique(request.resource.data.username)
        )) || 
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['following'])) ||
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers']))
      );
      allow delete: if isSignedIn() && isOwner(userId);
    }

    // Posts
    match /posts/{postId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) || 
        isFollowing(resource.data.userId) || 
        isPublicProfile(resource.data.userId)
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Stories
    match /stories/{storyId} {
      allow read: if isSignedIn() && (
        isOwner(resource.data.userId) || 
        isFollowing(resource.data.userId)
      );
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
    }

    // Chat rooms
    match /chatRooms/{roomId} {
      allow read: if isSignedIn() && isChatParticipant(resource.data.participants);
      allow create: if isSignedIn() && isChatParticipant(request.resource.data.participants);
      allow update: if isSignedIn() && isChatParticipant(resource.data.participants);
      allow delete: if false;

      // Chat messages
      match /messages/{messageId} {
        allow read: if isSignedIn() && isChatParticipant(get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants);
        allow create: if isSignedIn() && 
          isChatParticipant(get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants) &&
          request.resource.data.senderId == request.auth.uid;
        allow update: if isSignedIn() && 
          isChatParticipant(get(/databases/$(database)/documents/chatRooms/$(roomId)).data.participants) &&
          (resource.data.senderId == request.auth.uid || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']));
        allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
      }
    }

    // Comments
    match /posts/{postId}/comments/{commentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isOwner(resource.data.userId);
      allow delete: if isSignedIn() && (
        isOwner(resource.data.userId) || 
        isOwner(get(/databases/$(database)/documents/posts/$(postId)).data.userId)
      );
    }
  }
} 